name: Vercel Production Deployment
env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
on:
  push:
    branches:
      - master
      - production
jobs:
  test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '22'

            - name: Install dependencies
              run: npm ci

            - name: Run Vitest
              run: npx vitest run
            
            - name: Install Playwright Browsers
              run: npx playwright install --with-deps

            - name: Run Playwright Tests
              run: npx playwright test
            
            - name: Upload Playwright Traces
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                name: playwright-traces
                path: playwright-report/**/trace.zip
    
  Deploy-Production:
    needs: test
    runs-on:
      labels: ubuntu-latest
    steps:
      - name: Checkout the Codebase
        uses: actions/checkout@v4
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Deploy on Vercel
        id: deploy
        run: |
          vercel deploy --prod --token=${{ secrets.VERCEL_ACCESS_TOKEN }}
