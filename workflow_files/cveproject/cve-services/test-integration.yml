name: "Node Integration Tests"

# run this on a pull request for testing
on:
  pull_request:

# use a single job at first
jobs:
  run-integration-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@ee0669bd1cc54295c223e0bb666b733df41de1c5
    - name: Build and Run Services and Mongo Containers
      run: |
        cp docker/.docker-env.test-example docker/.docker-env
        docker compose --file docker/docker-compose.yml build
        docker compose --file docker/docker-compose.yml up -d
    - name: Sleep
      run: |
        dockercompose="docker compose --file docker/docker-compose.yml"
        attempts=60
        while ! $dockercompose logs cveawg | grep -q 'Serving on port'; do
          attempts=$(expr $attempts - 1)
          if [ $($dockercompose ps --status running -q | wc -l) -eq 2 ] && [ $attempts -gt 0 ]; then
            sleep 10
            $dockercompose logs || true
            continue
          fi
          $dockercompose ps || true
          $dockercompose logs || true
          echo "==== COULD NOT FIND 'Serving on port' in cveawg output OR one of the services died ====" 1>&2
          exit 1
        done
    - name: Run Tests
      run: docker compose -f docker/docker-compose.yml exec -T cveawg npm run test:integration
      continue-on-error: false