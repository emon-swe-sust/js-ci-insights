name: Build and Deploy Site

on:
  workflow_dispatch:
  push:
    branches: [src]
  pull_request:
    branches: [src]
  schedule:
    - cron: "0 0 * * *" # Runs daily at midnight

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    if: "!contains(github.event.head_commit.message, '(CI)')"
    runs-on: ubuntu-latest
    env:
      HUGO_ENVIRONMENT: production

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          submodules: true  # Fetch Hugo themes
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

      - name: Set up Pixi
        uses: prefix-dev/setup-pixi@v0.9.0
        with:
          # Enable caching for the pixi environment.
          cache: true

      - name: Install Node and Ruby Dependencies
        run: pixi run npm install && pixi run bundle install

      - name: Install dart-sass
        uses: dw-labs-org/dart-sass-gha@v1

      - name: Restore Hugo Cache
        id: hugo-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: public
          key: ${{ runner.os }}-hugo-${{ hashFiles('**/pixi.lock') }}
          restore-keys: |
            ${{ runner.os }}-hugo-

      - name: Configure Git
        run: git config --global core.quotepath false

      - name: Build site with Hugo
        run: pixi run bundle exec rake hugoBuild

      - name: Send arXiv Trackbacks
        if: github.event_name == 'push' && github.ref == 'refs/heads/src'
        run: pixi run uv run scripts/arxiv_trackbacks.py --site-url "https://rgoswami.me"

      - name: Commit and Push Updated Trackback Log
        if: github.event_name == 'push' && github.ref == 'refs/heads/src'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet .sent_trackbacks.log; then
            git add .sent_trackbacks.log
            # The commit message MUST contain '(CI)' to be ignored by the next run
            git commit -m "DOCS: Update sent trackbacks log (CI)"
            git push
            echo "Trackback log was updated and pushed to the repository."
          else
            echo "No changes to the trackback log."
          fi

      - name: Save Trackback Log
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .sent_trackbacks.log
          key: ${{ steps.trackback-cache-restore.outputs.cache-primary-key || format('{0}-trackbacks-{1}', runner.os, github.ref_name) }}

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/src' && !contains(github.event.head_commit.message, 'ImgBot')
        uses: peaceiris/actions-gh-pages@v4
        with:
          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
          publish_branch: gh-pages
          publish_dir: ./public
          keep_files: true
          enable_jekyll: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
