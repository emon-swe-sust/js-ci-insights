name: Test Build
on: [push, pull_request]

jobs:
  test_build:
    name: Basic CI
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
    - name: 'Build Image'
      run: |
        ./docker/build.sh
    - name: 'Run Devel Build'
      run: |
        ./docker/run.sh make test-build
    - name: Upload document artifacts
      uses: actions/upload-artifact@v4
      id: artifact-upload-step
      with:
        name: rosindex-test-render-${{ github.event.pull_request.number }}
        path: _site
        retention-days: 30 # default 90
        compression-level: 9 # maximum compression, default 6
        if-no-files-found: error # 'warn' or 'ignore' are also available, defaults to `warn`

    - name: Find Site Test Render link comment
      uses: peter-evans/find-comment@v3
      id: find-comment
      # Skip if PR from fork
      if: github.repository == github.event.pull_request.head.repo.full_name
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: "Site Test Render:"

    - name: Create or update Site Test Render link comment
      uses: peter-evans/create-or-update-comment@v4
      # Skip if PR from fork
      if: github.repository == github.event.pull_request.head.repo.full_name
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          Site Test Render: ${{ steps.artifact-upload-step.outputs.artifact-url }}.

          To view the resulting site:
          1. Click on the above link to download the artifacts archive
          2. Extract it
          3. View it using your favorite local rendering tool.
            a. As one example: Run `ghrocker --devel rosindex-test-render-${{ github.event.pull_request.number }}` Requires ghrocker installed https://github.com/tfoote/ghrocker
            b. Open http://localhost:4000 in your favorite browser
        edit-mode: replace