name: Node.js CI

on: [push, pull_request]

jobs:

  validation:

    name: Validation docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Docs
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-env

      - name: Validation
        run: npm run validate-docs

      - name: Archive internal-tools artifacts
        uses: actions/upload-artifact@v4
        with:
          name: internal-tools-artifacts-validation
          path: artifacts/internal-tools/
          retention-days: 7

  build:

    name: ContentMap
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Docs
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-env

      - name: Generate ContentMaps
        run: npm run generate-content-map

      - name: Archive internal-tools artifacts
        uses: actions/upload-artifact@v4
        with:
          name: internal-tools-artifacts-build
          path: artifacts/internal-tools/
          retention-days: 7

  link:
    runs-on: ubuntu-latest

    name: Check links
    steps:
      - name: Checkout Docs
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-env

      - name: Generate ContentMaps
        run: npm run generate-content-map

      - name: Check links
        run: npm run validate-links

      - name: Archive internal-tools artifacts
        uses: actions/upload-artifact@v4
        with:
          name: internal-tools-artifacts-link
          path: artifacts/internal-tools/
          retention-days: 7

  # modules:
  #   runs-on: ubuntu-latest
  #   name: Check modules guide
  #   steps:

  #   - name: Check modules guide
  #     run: npm run validate-modules-guide

  #   - name: Archive internal-tools artifacts
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: internal-tools-artifacts
  #       path: artifacts/internal-tools/
  #       retention-days: 7

  merge-artifacts:
    runs-on: ubuntu-latest
    needs: [ validation, build, link ]

    steps:
      - name: Merge artifacts
        uses: actions/upload-artifact/merge@v4
        continue-on-error: true
        with:
          name: internal-tools-artifacts
          pattern: internal-tools-artifacts-*
          delete-merged: true
