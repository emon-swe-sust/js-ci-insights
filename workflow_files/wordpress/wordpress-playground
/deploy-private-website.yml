name: Deploy private Playground web app

on:
    workflow_dispatch:
    # Deploy the website every day at 9am and 6pm UTC
    schedule:
        - cron: '0 9,18 * * *'

concurrency:
    group: website-deployment

jobs:
    build_and_deploy:
        # Only run this workflow from the trunk branch and when it's triggered by another workflow OR a Playground maintainer
        if: >
            github.ref == 'refs/heads/trunk' && (
                github.event_name == 'workflow_run' ||
                github.event_name == 'workflow_dispatch' ||
                github.actor == 'adamziel' ||
                github.actor == 'dmsnell' ||
                github.actor == 'bgrgicak' ||
                github.actor == 'brandonpayton' ||
                github.actor == 'zaerl' ||
                github.actor == 'janjakes'
            )

        # Specify runner + deployment step
        runs-on: ubuntu-latest
        environment:
            name: internal-web-app-deployment
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: true
            - uses: ./.github/actions/prepare-playground
            - run: npx nx build playground-website
              env:
                  CORS_PROXY_URL: ${{ vars.CORS_PROXY_URL }}

            - name: Deploy to playground.wordpress.net
              shell: bash
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.DEPLOY_WEBSITE_TARGET_HOST_KEY }}" >> ~/.ssh/known_hosts
                  echo "${{ secrets.DEPLOY_WEBSITE_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
                  chmod 0600 ~/.ssh/*

                  # Add site privacy script to the website build
                  # NOTE: We are no longer enforcing privacy so we can use our private instance in public contexts, like WordPress.com
                  # cp packages/playground/website-deployment/a8c/site-privacy.php \
                  #   dist/packages/playground/wasm-wordpress-net/

                  # Website files
                  rsync -avz -e "ssh -i ~/.ssh/id_ed25519" --delete \
                    dist/packages/playground/wasm-wordpress-net/ \
                    ${{ secrets.DEPLOY_WEBSITE_TARGET_USER }}@${{ secrets.DEPLOY_WEBSITE_TARGET_HOST }}:'~/updated-playground-files'

                  # Include MIME types for use with PHP-served files
                  cp packages/php-wasm/universal/src/lib/mime-types.json \
                    packages/playground/website-deployment/

                  # Host-specific deployment scripts and server config
                  rsync -avz -e "ssh -i ~/.ssh/id_ed25519" --delete \
                    packages/playground/website-deployment/ \
                    ${{ secrets.DEPLOY_WEBSITE_TARGET_USER }}@${{ secrets.DEPLOY_WEBSITE_TARGET_HOST }}:'~/website-deployment'

                  # Apply update
                  ssh -i ~/.ssh/id_ed25519 \
                    ${{ secrets.DEPLOY_WEBSITE_TARGET_USER }}@${{ secrets.DEPLOY_WEBSITE_TARGET_HOST }} \
                    -tt '~/website-deployment/apply-update.sh'

                  # Enforce privacy for web app
                  # NOTE: We are no longer enforcing privacy so we can use our private instance in public contexts, like WordPress.com
                  # ssh -i ~/.ssh/id_ed25519 \
                  #   ${{ secrets.DEPLOY_WEBSITE_TARGET_USER }}@${{ secrets.DEPLOY_WEBSITE_TARGET_HOST }} \
                  #   -tt 'sed -i "2i if ( \"cli\" !== php_sapi_name() ) { require_once __DIR__ . \"/site-privacy.php\"; Site_Privacy::enforce();	}" ~/htdocs/custom-redirects.php'
