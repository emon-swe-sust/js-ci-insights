name: PR Translation Workflow

on:
  pull_request:
    types: [opened, synchronize, labeled, closed]
    paths: ['docs/**']
  pull_request_target:
    types: [opened, synchronize, labeled, reopened, closed]
  issue_comment:
    types: [created]

# éœ€è¦å¯¹ PR/è¯„è®ºå…·å¤‡å†™æƒé™ï¼›å¯¹å†…å®¹å…·å¤‡è¯»å†™ï¼ˆç”¨äºåœ¨å¯å†™æƒ…å½¢ä¸‹æ¨é€ï¼‰ã€‚
permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: pr-translation-${{ github.event_name }}-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  # æ£€æµ‹ PR ä¸­çš„æ–‡æ¡£å˜æ›´
  detect-docs-changes:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    outputs:
      has-docs-changes: ${{ steps.changes.outputs.any_changed }}
      changed-files: ${{ steps.analyze.outputs.changed_files }}
      total-files: ${{ steps.analyze.outputs.total_files }}
      operation-summary: ${{ steps.analyze.outputs.operation_summary }}
      skip-comment: ${{ steps.check-skip.outputs.skip }}
    steps:
      - name: Check if should skip (via last PR commit message)
        id: check-skip
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            try {
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });

              // å…³é”®ï¼šä½¿ç”¨â€œPR å¤´ä»“åº“â€çš„ owner/repo
              const [headOwner, headRepo] = pr.head.repo.full_name.split('/');
              const headSha = pr.head.sha;

              const { data: commit } = await github.rest.repos.getCommit({
                owner: headOwner,
                repo: headRepo,
                ref: headSha
              });

              const message = commit?.commit?.message || '';

              if (
                message.includes('ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£') ||
                message.includes('ğŸ”„ æ’¤å›ç¿»è¯‘') ||
                message.includes('[TRANSLATION_COMMIT]: true')
              ) {
                core.info('æ£€æµ‹åˆ°ç¿»è¯‘/æ’¤å› commitï¼Œè·³è¿‡æ–‡æ¡£å˜æ›´æ£€æµ‹å’Œè¯„è®º');
                core.setOutput('skip', 'true');
                return;
              }
            } catch (e) {
              core.warning('è¯»å– PR æäº¤ä¿¡æ¯å¤±è´¥ï¼š' + e.message);
            }
            core.setOutput('skip', 'false');

      - uses: actions/checkout@v4
        if: steps.check-skip.outputs.skip != 'true'
        with:
          fetch-depth: 2
          fetch-tags: false
          sparse-checkout: |
            docs
          sparse-checkout-cone-mode: true

      - name: Check for docs changes
        id: changes
        if: steps.check-skip.outputs.skip != 'true'
        uses: tj-actions/changed-files@v40
        with:
          files: |
            docs/**/*.{md,mdx}
            docs/**/_category_.yml
          files_ignore: |
            docs/zh-CN/**
            docs/ja/**
            docs/es/**

      - name: Ensure base commit is available
        if: steps.changes.outputs.any_changed == 'true' && steps.check-skip.outputs.skip != 'true'
        run: |
          git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}

      - name: Analyze changes
        id: analyze
        if: steps.changes.outputs.any_changed == 'true' && steps.check-skip.outputs.skip != 'true'
        run: |
          echo "ğŸ“Š åˆ†ææ–‡æ¡£å˜æ›´..."
          base_sha="${{ github.event.pull_request.base.sha }}"
          echo "ğŸ” åŸºç¡€SHA: $base_sha"

          added_count=0
          modified_count=0
          deleted_count=0
          renamed_count=0
          renamed_modified_count=0
          all_files=""

          if operations=$(git diff --name-status --find-renames=90 $base_sha..HEAD -- docs/ 2>/dev/null); then
            filtered_operations=$(echo "$operations" | grep -E '\.(md|mdx)$|_category_\.yml$' | grep -v -E '(zh-CN|ja|es)' || true)
            if [[ -n "$filtered_operations" ]]; then
              while IFS=$'\t' read -r status file rest || [[ -n "$status" ]]; do
                [[ -z "$status" ]] && continue
                case "$status" in
                  A*) added_count=$((added_count + 1)); all_files="$all_files$file " ;;
                  M*) modified_count=$((modified_count + 1)); all_files="$all_files$file " ;;
                  D*) deleted_count=$((deleted_count + 1)); all_files="$all_files$file " ;;
                  R[0-9][0-9])
                    similarity=${status#R}
                    if [ "$similarity" -lt 100 ]; then
                      renamed_modified_count=$((renamed_modified_count + 1))
                    else
                      renamed_count=$((renamed_count + 1))
                    fi
                    all_files="$all_files$file "
                    [[ -n "$rest" ]] && all_files="$all_files$rest "
                    ;;
                  R*) renamed_count=$((renamed_count + 1)); all_files="$all_files$file "; [[ -n "$rest" ]] && all_files="$all_files$rest " ;;
                esac
              done <<< "$filtered_operations"
            fi
          fi

          total_count=$((added_count + modified_count + deleted_count + renamed_count + renamed_modified_count))
          echo "changed_files=$all_files" >> $GITHUB_OUTPUT
          echo "total_files=$total_count" >> $GITHUB_OUTPUT
          echo "operation_summary=æ–°å¢:$added_count ä¿®æ”¹:$modified_count åˆ é™¤:$deleted_count ç§»åŠ¨:$renamed_count ç§»åŠ¨+ä¿®æ”¹:$renamed_modified_count" >> $GITHUB_OUTPUT

  # æ·»åŠ ç¿»è¯‘æç¤ºè¯„è®ºï¼ˆåªåœ¨éç¿»è¯‘/æ’¤å› commit æ—¶æ·»åŠ ï¼‰
  add-translation-comment:
    if: github.event_name == 'pull_request_target' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    steps:
      # å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡ï¼ˆå¦‚æœæœ€è¿‘ä¸€æ¬¡æäº¤æ˜¯"è‡ªåŠ¨ç¿»è¯‘/æ’¤å›"ï¼‰
      - name: Check if should skip (via last PR commit message)
        id: check-skip
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            try {
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });

              // å…³é”®ï¼šä½¿ç”¨â€œPR å¤´ä»“åº“â€çš„ owner/repo
              const [headOwner, headRepo] = pr.head.repo.full_name.split('/');
              const headSha = pr.head.sha;

              const { data: commit } = await github.rest.repos.getCommit({
                owner: headOwner,
                repo: headRepo,
                ref: headSha
              });

              const message = commit?.commit?.message || '';

              if (
                message.includes('ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£') ||
                message.includes('ğŸ”„ æ’¤å›ç¿»è¯‘') ||
                message.includes('[TRANSLATION_COMMIT]: true')
              ) {
                core.info('æ£€æµ‹åˆ°ç¿»è¯‘/æ’¤å› commitï¼Œè·³è¿‡æ–‡æ¡£å˜æ›´æ£€æµ‹å’Œè¯„è®º');
                core.setOutput('skip', 'true');
                return;
              }
            } catch (e) {
              core.warning('è¯»å– PR æäº¤ä¿¡æ¯å¤±è´¥ï¼š' + e.message);
            }
            core.setOutput('skip', 'false');

      # ä½¿ç”¨ API ç›´æ¥ç»Ÿè®¡å˜æ›´ï¼Œé¿å… checkout / git diff
      - name: Analyze docs changes (fast via API)
        id: analyze
        if: steps.check-skip.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;

            let page = 1, files = [];
            while (true) {
              const { data } = await github.rest.pulls.listFiles({
                owner, repo, pull_number: pr_number, per_page: 100, page
              });
              if (!data.length) break;
              files = files.concat(data);
              page++;
            }

            const isDocs = f =>
              /^docs\//.test(f.filename) &&
              !/^docs\/(zh-CN|ja|es)\//.test(f.filename) &&
              (/\.(md|mdx)$/.test(f.filename) || /_category_\.yml$/.test(f.filename));

            const picked = files.filter(isDocs);

            let added=0, modified=0, deleted=0, renamed=0, renamed_modified=0;
            for (const f of picked) {
              if (f.status === 'added') added++;
              else if (f.status === 'modified') modified++;
              else if (f.status === 'removed') deleted++;
              else if (f.status === 'renamed') {
                if ((f.changes ?? 0) > 0) renamed_modified++; else renamed++;
              }
            }
            const total = picked.length;
            core.setOutput('total_files', String(total));
            core.setOutput('operation_summary',
              `æ–°å¢:${added} ä¿®æ”¹:${modified} åˆ é™¤:${deleted} ç§»åŠ¨:${renamed} ç§»åŠ¨+ä¿®æ”¹:${renamed_modified}`);

      - name: Add translation comment
        if: steps.check-skip.outputs.skip != 'true' && steps.analyze.outputs.total_files != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            const totalFiles = '${{ steps.analyze.outputs.total_files }}';
            const operationSummary = '${{ steps.analyze.outputs.operation_summary }}';

            let comment = `## ğŸŒ æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´ - å¯è¿›è¡Œå¤šè¯­è¨€ç¿»è¯‘\n\n`;
            comment += `**ç»Ÿè®¡ä¿¡æ¯:** å…± ${totalFiles} ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\n`;
            comment += `**æ“ä½œç±»å‹:** ${operationSummary}\n\n`;

            comment += `### ğŸš€ å¼€å§‹ç¿»è¯‘\n`;
            comment += `åœ¨æ­¤è¯„è®ºå›å¤ä»¥ä¸‹å‘½ä»¤ä¹‹ä¸€ï¼š\n\n`;
            comment += `- \`/translate all\` - ç¿»è¯‘æ‰€æœ‰å˜æ›´åˆ°æ‰€æœ‰è¯­è¨€ (ä¸­æ–‡ã€æ—¥æ–‡ã€è¥¿ç­ç‰™è¯­)\n`;
            comment += `- \`/translate zh\` - ä»…ç¿»è¯‘åˆ°ä¸­æ–‡\n`;
            comment += `- \`/translate ja\` - ä»…ç¿»è¯‘åˆ°æ—¥æ–‡\n`;
            comment += `- \`/translate es\` - ä»…ç¿»è¯‘åˆ°è¥¿ç­ç‰™è¯­\n`;
            comment += `- \`/translate zh ja\` - ç¿»è¯‘åˆ°ä¸­æ–‡å’Œæ—¥æ–‡\n`;
            comment += `- \`/translate zh es\` - ç¿»è¯‘åˆ°ä¸­æ–‡å’Œè¥¿ç­ç‰™è¯­\n\n`;

            comment += `### ğŸ”„ æ’¤å›ç¿»è¯‘\n`;
            comment += `å¦‚æœå¯¹ç¿»è¯‘ç»“æœä¸æ»¡æ„ï¼Œå¯ä»¥ä½¿ç”¨ï¼š\n`;
            comment += `- \`/rollback translation\` - æ’¤å›æœ€è¿‘ä¸€æ¬¡çš„ç¿»è¯‘æäº¤\n\n`;

            comment += `### âš ï¸ æ³¨æ„äº‹é¡¹\n`;
            comment += `- åªæœ‰ä»“åº“ç®¡ç†å‘˜å’Œç»´æŠ¤è€…å¯ä»¥è§¦å‘ç¿»è¯‘å’Œæ’¤å›\n`;
            comment += `- è‹¥ PR æ¥è‡ª forkï¼Œè¯·ç¡®ä¿ä½œè€…å‹¾é€‰ **Allow edits from maintainers**ï¼Œå¦åˆ™æœºå™¨äººæ— æ³•æŠŠç¿»è¯‘æ¨å› PR åˆ†æ”¯\n`;
            comment += `- æ’¤å›æ“ä½œä¼šæ¢å¤åˆ°ç¿»è¯‘å‰çš„çŠ¶æ€\n`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: comment
            })

  # â€”â€” æ‰‹åŠ¨è§¦å‘ç¿»è¯‘ â€”â€” #
  manual-translate:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/translate')
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    outputs:
      translation-completed: ${{ steps.check-completion.outputs.completed }}
      has-changes: ${{ steps.check-completion.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
          fetch-tags: false

      - name: Get PR context (head repo/ref & permissions)
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: issue_number });
            core.setOutput('head-repo', pr.head.repo.full_name);
            core.setOutput('head-ref', pr.head.ref);
            core.setOutput('base-sha', pr.base.sha);
            core.setOutput('head-sha', pr.head.sha);
            core.setOutput('is-fork', pr.head.repo.fork ? 'true' : 'false');
            core.setOutput('maintainer-can-modify', pr.maintainer_can_modify ? 'true' : 'false');
            core.setOutput('base-ref', pr.base.ref);

      - name: Add start comment
        id: start-comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const username = context.payload.comment.user.login;
            const comment = `## ğŸ”„ å¼€å§‹ç¿»è¯‘ä»»åŠ¡\n\n` +
              `**è§¦å‘è€…:** @${username}\n` +
              `**å¼€å§‹æ—¶é—´:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n` +
              `**å‘½ä»¤:** \`${context.payload.comment.body.trim()}\`\n\n` +
              `â³ æ­£åœ¨æ£€æŸ¥æƒé™å’Œåˆå§‹åŒ–ç¿»è¯‘ç¯å¢ƒ...\n\n` +
              `> ğŸ” ç¿»è¯‘å®Œæˆåä¼šåœ¨æ­¤æ›´æ–°è¯¦ç»†æŠ¥å‘Š`;
            const res = await github.rest.issues.createComment({ owner, repo, issue_number, body: comment });
            return res.data.id

      - name: Check user permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const username = context.payload.comment.user.login;
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({ owner, repo, username });
            const allowed = ['admin','maintain'].includes(permission.permission);
            if (!allowed) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: context.payload.issue.number,
                body: `## âŒ æƒé™ä¸è¶³\n\n@${username} æƒé™ä¸è¶³ï¼Œåªæœ‰ä»“åº“ç®¡ç†å‘˜å’Œç»´æŠ¤è€…å¯ä»¥è§¦å‘ç¿»è¯‘ã€‚\n\n**å½“å‰æƒé™:** \`${permission.permission}\``
              });
              core.setFailed('æƒé™ä¸è¶³');
              return;
            }
            core.setOutput('has_permission','true');

      - name: Ensure fork is editable by maintainers (for forked PR)
        if: steps.check-permissions.outputs.has_permission == 'true' && steps.pr-info.outputs.is-fork == 'true' && steps.pr-info.outputs.maintainer-can-modify != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const username = context.payload.comment.user.login;
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `## âš ï¸ æ— æ³•å†™å…¥ PR åˆ†æ”¯\n\nè¯¥ PR æ¥è‡ª forkï¼Œä¸”æœªå¼€å¯ **Allow edits from maintainers**ã€‚\n\nè¯· PR ä½œè€…è¿›å…¥å³ä¾§æ å‹¾é€‰æ­¤é€‰é¡¹ï¼Œç„¶åè¯„è®º \`/translate ...\` é‡æ–°è§¦å‘ã€‚`
            });
            core.setFailed('fork æœªå…è®¸ç»´æŠ¤è€…ç¼–è¾‘ï¼Œæ— æ³•å°†ç¿»è¯‘æ¨å› PR æºåˆ†æ”¯');

      # ç›´æ¥æ£€å‡º PR headï¼ˆæµ…å…‹éš† + ç¨€ç–ï¼‰
      - name: Checkout PR head (fast)
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr-info.outputs.head-repo }}
          ref: ${{ steps.pr-info.outputs.head-ref }}
          fetch-depth: 2
          fetch-tags: false
          sparse-checkout: |
            docs
          sparse-checkout-cone-mode: true
          filter: blob:none

      - name: Checkout trusted scripts (base repo)
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}          # æˆ–å›ºå®šåˆ° main ç­‰å—ä¿æŠ¤åˆ†æ”¯
          fetch-depth: 1
          fetch-tags: false
          sparse-checkout: |
            .github/scripts
          sparse-checkout-cone-mode: true
          filter: blob:none
          path: _trusted

      - name: Record BEFORE SHA
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        run: |
          BEFORE_TRANSLATION_SHA=$(git rev-parse HEAD)
          echo "BEFORE_TRANSLATION_SHA=$BEFORE_TRANSLATION_SHA" >> $GITHUB_ENV
          echo "ğŸ“Œ è®°å½•ç¿»è¯‘å‰çš„SHA: $BEFORE_TRANSLATION_SHA"

      - name: Ensure base SHA is available for diff
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        run: |
          git fetch --depth=1 origin ${{ steps.pr-info.outputs.base-sha }}

      - name: Setup Node.js
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Parse translation command
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        id: parse
        run: |
          comment="${{ github.event.comment.body }}"
          echo "ğŸ” è§£æç¿»è¯‘å‘½ä»¤: $comment"
          if [[ "$comment" == *"/translate all"* ]]; then
            languages="zh-CN ja es"
          else
            languages=""
            [[ "$comment" == *" zh"* ]] && languages="$languages zh-CN"
            [[ "$comment" == *" ja"* ]] && languages="$languages ja"
            [[ "$comment" == *" es"* ]] && languages="$languages es"
          fi
          languages=$(echo $languages | xargs)
          echo "languages=$languages" >> $GITHUB_OUTPUT
          echo "ğŸ¯ æœ€ç»ˆç¿»è¯‘è¯­è¨€: $languages"

      - name: Cache npm
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-anthropic-sdk-v1
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        run: |
          echo "ğŸ“¦ å®‰è£…ç¿»è¯‘ä¾èµ–..."
          npm install @anthropic-ai/sdk --no-save --legacy-peer-deps

      - name: Run translation
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        env:
          TRANSLATION_API_KEY: ${{ secrets.TRANSLATION_API_KEY }}
          TARGET_LANGUAGES: ${{ steps.parse.outputs.languages }}
          BASE_SHA: ${{ steps.pr-info.outputs.base-sha }}
        run: |
          echo "ğŸš€ å¼€å§‹ç¿»è¯‘ä»»åŠ¡..."
          echo "ç›®æ ‡è¯­è¨€: $TARGET_LANGUAGES"
          echo "åŸºç¡€SHA: $BASE_SHA"
          if [ -z "$TRANSLATION_API_KEY" ]; then
            echo "âŒ ç¼ºå°‘ TRANSLATION_API_KEY"
            exit 1
          fi
          node _trusted/.github/scripts/translate.js

      - name: Commit and push changes (push back to PR head repo/ref)
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        env:
          TRANSLATION_PAT: ${{ secrets.TRANSLATION_PAT }}
          LANGUAGES: ${{ steps.parse.outputs.languages }}
          TRIGGERED_BY: ${{ github.event.comment.user.login }}
          HEAD_REPO: ${{ steps.pr-info.outputs.head-repo }}
          HEAD_REF: ${{ steps.pr-info.outputs.head-ref }}
        run: |
          echo "ğŸ”„ æäº¤ç¿»è¯‘ç»“æœ..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          echo "ğŸ“‹ å½“å‰gitçŠ¶æ€ï¼š"
          git status --short || true

          git checkout -- yarn.lock package-lock.json 2>/dev/null || true

          if [ -n "$(git status --porcelain docs/)" ]; then
            git add docs/
            COMMIT_MSG="ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£"
            COMMIT_DETAILS="Translation Languages: ${LANGUAGES}
          Before Translation SHA: ${BEFORE_TRANSLATION_SHA}
          Triggered by: @${TRIGGERED_BY}
          Time: $(date '+%Y-%m-%d %H:%M:%S')"
            git commit -m "$COMMIT_MSG" -m "$COMMIT_DETAILS"

            # å…³é”®ï¼šæ¨é€åˆ° PR çš„ head ä»“åº“ä¸åˆ†æ”¯
            if [ -n "$TRANSLATION_PAT" ]; then
              remote_url="https://${TRANSLATION_PAT}@github.com/${HEAD_REPO}.git"
            else
              # é€€åŒ–æ–¹æ¡ˆï¼šä½¿ç”¨ GITHUB_TOKENï¼›ä»…å½“ PR æ¥è‡ªåŒä»“åº“åˆ†æ”¯æ—¶å¯ç”¨
              remote_url="https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${HEAD_REPO}.git"
            fi

            echo "â¡ï¸ æ¨é€åˆ° ${HEAD_REPO} çš„ ${HEAD_REF}"
            git push "$remote_url" HEAD:"${HEAD_REF}"

            echo "HAS_CHANGES=true" >> $GITHUB_ENV
            echo "TRANSLATION_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
            echo "âœ… ç¿»è¯‘ç»“æœå·²æäº¤å¹¶æ¨é€"
          else
            echo "â„¹ï¸ æ²¡æœ‰ç¿»è¯‘å†…å®¹éœ€è¦æäº¤"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: Trigger Test deployment (Check_PR_Update.yml)
        if: env.HAS_CHANGES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflowFile = '.github/workflows/Check_PR_Update.yml';
            const prNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            const baseRef = '${{ steps.pr-info.outputs.base-ref }}';
            const headRef = '${{ steps.pr-info.outputs.head-ref }}';
            const headRepo = '${{ steps.pr-info.outputs.head-repo }}';

            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: workflowFile,
              ref: baseRef,
              inputs: {
                pr_number: String(prNumber),
                ref: headRef,
                head_repo: headRepo,
                trigger_source: 'translation'
              }
            });
            core.info(`Dispatched ${workflowFile} on ${baseRef} for PR #${prNumber} (head=${headRepo}:${headRef})`);

      - name: Save translation metadata
        if: steps.check-permissions.outputs.has_permission == 'true' && env.HAS_CHANGES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.issue.number;
            const metadata = {
              before_sha: process.env.BEFORE_TRANSLATION_SHA,
              after_sha: process.env.TRANSLATION_COMMIT_SHA,
              languages: '${{ steps.parse.outputs.languages }}',
              timestamp: new Date().toISOString(),
              triggered_by: '${{ github.event.comment.user.login }}'
            };
            const body = `<!-- TRANSLATION_METADATA
            ${JSON.stringify(metadata)}
            -->`;
            await github.rest.issues.createComment({ owner, repo, issue_number: pr_number, body });

      - name: Check completion status
        id: check-completion
        if: always() && steps.check-permissions.outputs.has_permission == 'true'
        run: |
          if [ "${{ job.status }}" = "success" ] && [ "$HAS_CHANGES" = "true" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Update completion comment
        if: always() && steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const commentId = '${{ steps.start-comment.outputs.result }}';
            const success = '${{ job.status }}' === 'success';
            const languages = '${{ steps.parse.outputs.languages }}';
            const hasChanges = process.env.HAS_CHANGES === 'true';
            const translationSha = process.env.TRANSLATION_COMMIT_SHA || 'N/A';
            const beforeSha = process.env.BEFORE_TRANSLATION_SHA || 'N/A';

            let status, icon;
            if (success && hasChanges) { status='ç¿»è¯‘å®Œæˆ'; icon='âœ…'; }
            else if (success && !hasChanges) { status='æ— éœ€ç¿»è¯‘'; icon='â„¹ï¸'; }
            else { status='ç¿»è¯‘å¤±è´¥'; icon='âŒ'; }

            let comment = `## ${icon} ${status}\n\n`;
            comment += `**ç¿»è¯‘è¯­è¨€:** ${languages || 'æ— '}\n`;
            comment += `**å®Œæˆæ—¶é—´:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n`;
            comment += `**è§¦å‘è€…:** @${{ github.event.comment.user.login }}\n`;
            if (success && hasChanges) {
              comment += `**ç¿»è¯‘å‰SHA:** \`${beforeSha}\`\n`;
              comment += `**ç¿»è¯‘åSHA:** \`${translationSha}\`\n\n`;
              comment += `### ğŸ‰ ç¿»è¯‘æˆåŠŸï¼\n\nç¿»è¯‘æ–‡ä»¶å·²è‡ªåŠ¨æäº¤åˆ°å½“å‰PRåˆ†æ”¯ã€‚\n\n`;
              comment += `### ğŸ”„ åç»­æ“ä½œ\n- å¦‚æœå¯¹ç¿»è¯‘ç»“æœä¸æ»¡æ„ï¼Œå¯ä»¥ä½¿ç”¨ \`/rollback translation\` æ’¤å›æ­¤æ¬¡ç¿»è¯‘\n- æ’¤å›åå¯ä»¥é‡æ–°ç¿»è¯‘æˆ–æ‰‹åŠ¨ä¿®æ”¹\n\n`;
            } else if (success && !hasChanges) {
              comment += `### ğŸ” æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦ç¿»è¯‘çš„å†…å®¹\n\nå¯èƒ½çš„åŸå› ï¼š\n- ç›®æ ‡è¯­è¨€çš„ç¿»è¯‘æ–‡ä»¶å·²ç»æ˜¯æœ€æ–°çš„\n- æ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆçš„æ–‡æ¡£å˜æ›´\n\n`;
            } else {
              comment += `### ğŸ’” ç¿»è¯‘å¤±è´¥\n\nè¯·æŸ¥çœ‹ [å·¥ä½œæµæ—¥å¿—](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})ã€‚\n\n`;
            }
            try {
              const fs = require('fs');
              if (fs.existsSync('/tmp/translation-report.md')) {
                const report = fs.readFileSync('/tmp/translation-report.md','utf8');
                comment += `### ğŸ“Š è¯¦ç»†æŠ¥å‘Š\n\n${report}`;
              }
            } catch {}
            comment += `\n---\n> ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | [æŸ¥çœ‹å·¥ä½œæµ](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})`;
            try {
              await github.rest.issues.updateComment({ owner, repo, comment_id: commentId, body: comment });
            } catch {
              await github.rest.issues.createComment({ owner, repo, issue_number: issue_number, body: comment });
            }

  # â€”â€” æ’¤å›ç¿»è¯‘ â€”â€” #
  rollback-translation:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/rollback translation')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
          fetch-tags: false

      - name: Get PR context (head repo/ref & permissions)
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: issue_number });
            core.setOutput('head-repo', pr.head.repo.full_name);
            core.setOutput('head-ref', pr.head.ref);
            core.setOutput('is-fork', pr.head.repo.fork ? 'true' : 'false');
            core.setOutput('maintainer-can-modify', pr.maintainer_can_modify ? 'true' : 'false');
            core.setOutput('base-ref', pr.base.ref);

      - name: Check user permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const username = context.payload.comment.user.login;
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({ owner, repo, username });
            const allowed = ['admin','maintain'].includes(permission.permission);
            if (!allowed) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: context.payload.issue.number,
                body: `## âŒ æƒé™ä¸è¶³\n\n@${username} æ²¡æœ‰æ’¤å›ç¿»è¯‘çš„æƒé™ã€‚`
              });
              core.setFailed('æƒé™ä¸è¶³'); return;
            }
            core.setOutput('has_permission','true');

      - name: Ensure fork is editable by maintainers (for forked PR)
        if: steps.check-permissions.outputs.has_permission == 'true' && steps.pr-info.outputs.is-fork == 'true' && steps.pr-info.outputs.maintainer-can-modify != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `## âš ï¸ æ— æ³•å†™å…¥ PR åˆ†æ”¯\n\nè¯¥ PR æ¥è‡ª forkï¼Œä¸”æœªå¼€å¯ **Allow edits from maintainers**ï¼Œæ— æ³•æ‰§è¡Œæ’¤å›ã€‚\n\nè¯· PR ä½œè€…å¼€å¯è¯¥é€‰é¡¹åå†è¯•ã€‚`
            });
            core.setFailed('fork æœªå…è®¸ç»´æŠ¤è€…ç¼–è¾‘ï¼Œæ— æ³•æ’¤å›');

      - name: Find translation metadata
        id: find-metadata
        if: steps.check-permissions.outputs.has_permission == 'true' && (steps.pr-info.outputs.is-fork != 'true' || steps.pr-info.outputs.maintainer-can-modify == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            let latest = null;
            const re = /<!-- TRANSLATION_METADATA\s+(.*?)\s+-->/s;
            for (const c of comments.data.reverse()) {
              const m = c.body.match(re);
              if (m) { try { latest = JSON.parse(m[1]); break; } catch {} }
            }
            if (!latest) {
              await github.rest.issues.createComment({ owner, repo, issue_number, body: `## âš ï¸ æœªæ‰¾åˆ°ç¿»è¯‘è®°å½•` });
              core.setFailed('æœªæ‰¾åˆ°ç¿»è¯‘å…ƒæ•°æ®'); return;
            }
            core.setOutput('before_sha', latest.before_sha);
            core.setOutput('after_sha', latest.after_sha);
            core.setOutput('languages', latest.languages);
            core.setOutput('has_metadata', 'true');

      # ç›´æ¥æ£€å‡º PR headï¼ˆæµ…å…‹éš† + ç¨€ç–ï¼‰
      - name: Checkout PR head (fast)
        if: steps.find-metadata.outputs.has_metadata == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr-info.outputs.head-repo }}
          ref: ${{ steps.pr-info.outputs.head-ref }}
          fetch-depth: 2
          fetch-tags: false
          sparse-checkout: |
            docs
          sparse-checkout-cone-mode: true
          filter: blob:none

      - name: Checkout PR and rollback
        if: steps.find-metadata.outputs.has_metadata == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
          TRANSLATION_PAT: ${{ secrets.TRANSLATION_PAT }}
          HEAD_REPO: ${{ steps.pr-info.outputs.head-repo }}
          HEAD_REF: ${{ steps.pr-info.outputs.head-ref }}
        run: |
          BEFORE_SHA="${{ steps.find-metadata.outputs.before_sha }}"
          AFTER_SHA="${{ steps.find-metadata.outputs.after_sha }}"
          echo "ğŸ”„ å‡†å¤‡æ’¤å›ç¿»è¯‘..."
          echo "  ç¿»è¯‘å‰SHA: $BEFORE_SHA"
          echo "  ç¿»è¯‘åSHA: $AFTER_SHA"
          echo "  å½“å‰SHA: $(git rev-parse HEAD)"

          # ç¡®ä¿ç›®æ ‡æäº¤å­˜åœ¨äºæµ…å…‹éš†ä¸­
          git fetch --depth=1 origin "$BEFORE_SHA" || true
          git fetch --depth=1 origin "$AFTER_SHA" || true

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          git reset --hard "$BEFORE_SHA"

          if [ -n "$TRANSLATION_PAT" ]; then
            remote_url="https://${TRANSLATION_PAT}@github.com/${HEAD_REPO}.git"
          else
            remote_url="https://${GITHUB_ACTOR}:${GITHUB_TOKEN}@github.com/${HEAD_REPO}.git"
          fi
          echo "â¡ï¸ å¼ºåˆ¶æ¨é€å› ${HEAD_REPO}:${HEAD_REF}"
          git push --force "$remote_url" HEAD:"${HEAD_REF}"
          echo "âœ… å·²æ’¤å›åˆ°ç¿»è¯‘å‰çš„çŠ¶æ€"

      - name: Trigger Test deployment (Check_PR_Update.yml) after rollback
        if: steps.find-metadata.outputs.has_metadata == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflowFile = '.github/workflows/Check_PR_Update.yml';
            const prNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            const baseRef = '${{ steps.pr-info.outputs.base-ref }}';
            const headRef = '${{ steps.pr-info.outputs.head-ref }}';
            const headRepo = '${{ steps.pr-info.outputs.head-repo }}';

            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: workflowFile,
              ref: baseRef,
              inputs: {
                pr_number: String(prNumber),
                ref: headRef,
                head_repo: headRepo,
                trigger_source: 'rollback'
              }
            });
            core.info(`Dispatched ${workflowFile} on ${baseRef} for PR #${prNumber} (head=${headRepo}:${headRef})`);

      - name: Post rollback comment & cleanup metadata
        if: steps.find-metadata.outputs.has_metadata == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const username = context.payload.comment.user.login;
            const beforeSha = '${{ steps.find-metadata.outputs.before_sha }}';
            const afterSha = '${{ steps.find-metadata.outputs.after_sha }}';
            const languages = '${{ steps.find-metadata.outputs.languages }}';

            let body = `## âœ… ç¿»è¯‘å·²æ’¤å›\n\n`;
            body += `**æ“ä½œè€…:** @${username}\n`;
            body += `**æ’¤å›æ—¶é—´:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n`;
            body += `### ğŸ“‹ æ’¤å›è¯¦æƒ…\n- **æ’¤å›çš„ç¿»è¯‘è¯­è¨€:** ${languages}\n- **æ¢å¤åˆ°çš„SHA:** \`${beforeSha}\`\n- **æ’¤å›çš„SHA:** \`${afterSha}\`\n\n`;
            body += `---\n> ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ`;

            await github.rest.issues.createComment({ owner, repo, issue_number, body });

            const comments = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const re = /<!-- TRANSLATION_METADATA/;
            for (const c of comments.data) {
              if (re.test(c.body)) {
                await github.rest.issues.deleteComment({ owner, repo, comment_id: c.id });
                break;
              }
            }