name: Validate/Lint

on: [push, pull_request]

permissions:
  contents: read

jobs:
 build:
  runs-on: ${{ matrix.operating-system }}

  strategy:
   matrix:
    operating-system: [ubuntu-latest]
    php-versions: ['8.1', '8.2', '8.3']
  name: PHP ${{ matrix.php-versions }} on ${{ matrix.operating-system }}
  steps:
  - name: Checkout
    uses: actions/checkout@v5

  - name: Set up PHP
    uses: shivammathur/setup-php@v2
    with:
     php-version: ${{ matrix.php-versions }}
     extensions: pcre, mbstring, xml, curl, gd, mysql, zip, intl # Added common extensions
     coverage: none # Disable coverage for faster builds

  - name: Get composer cache directory
    id: composer-cache
    run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

  - name: Cache composer dependencies
    uses: actions/cache@v4
    with:
      path: ${{ steps.composer-cache.outputs.dir }}
      key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
      restore-keys: ${{ runner.os }}-composer-

  - name: Install dependencies
    run: composer install --prefer-dist --no-progress --no-suggest --no-dev

  - name: Validate composer.json and composer.lock
    run: composer validate --no-check-publish

  - name: Lint PHP files
    run: |
     set -e # Exit on any error
     lintPaths=()
     lintPaths+=("${GITHUB_WORKSPACE}/admin")
     lintPaths+=("${GITHUB_WORKSPACE}/feed")
     lintPaths+=("${GITHUB_WORKSPACE}/install")
     lintPaths+=("${GITHUB_WORKSPACE}/locale")
     lintPaths+=("${GITHUB_WORKSPACE}/objects")
     lintPaths+=("${GITHUB_WORKSPACE}/view")
     lintPaths+=("${GITHUB_WORKSPACE}/index.php")

     echo "Starting PHP lint check..."
     for lintPath in "${lintPaths[@]}"
     do
       if [ -e "$lintPath" ]; then
         echo "Checking: $lintPath"
         find "$lintPath" -name "*.php" -o -name "*.phtml" | while read -r file
         do
           php -l "$file" || exit 1
         done
       else
         echo "Warning: Path $lintPath does not exist"
       fi
     done
     echo "PHP lint check completed successfully!"
