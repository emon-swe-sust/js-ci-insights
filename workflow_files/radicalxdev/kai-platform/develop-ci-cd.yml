name: CI/CD Pipeline (Develop)

on:
  push:
    branches:
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_FIREBASE_CLIENT_API_KEY: ${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_CLIENT_API_KEY }}
      NEXT_PUBLIC_FIREBASE_CLIENT_AUTH_DOMAIN: ${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_CLIENT_AUTH_DOMAIN }}
      NEXT_PUBLIC_FIREBASE_CLIENT_PROJECT_ID: ${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_CLIENT_PROJECT_ID }}
      NEXT_PUBLIC_FIREBASE_CLIENT_STORAGE_BUCKET: ${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_CLIENT_STORAGE_BUCKET }}
      NEXT_PUBLIC_FIREBASE_CLIENT_MESSAGING_SENDER_ID: ${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_CLIENT_MESSAGING_SENDER_ID }}
      NEXT_PUBLIC_FIREBASE_CLIENT_APP_ID: ${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_CLIENT_APP_ID }}
      NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
      NEXT_PUBLIC_MARVEL_ENDPOINT: ${{ secrets.DEV_NEXT_PUBLIC_MARVEL_ENDPOINT }}
      MARVEL_API_KEY: ${{ secrets.DEV_MARVEL_API_KEY }}
      MARVEL_ENDPOINT: ${{ secrets.DEV_MARVEL_ENDPOINT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Firebase CLI
        run: |
          npm install -g firebase-tools
          firebase --version  # Verify installation

      - name: Install dependencies
        run: |
          npm install
          cd functions
          npm install
          cd ..

      - name: Create .env.production.local
        run: |
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_API_KEY=${NEXT_PUBLIC_FIREBASE_CLIENT_API_KEY}" >> .env.production.local
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_CLIENT_AUTH_DOMAIN}" >> .env.production.local
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_CLIENT_PROJECT_ID}" >> .env.production.local
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_CLIENT_STORAGE_BUCKET}" >> .env.production.local
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_CLIENT_MESSAGING_SENDER_ID}" >> .env.production.local
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_APP_ID=${NEXT_PUBLIC_FIREBASE_CLIENT_APP_ID}" >> .env.production.local
          echo "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}" >> .env.production.local
          echo "NEXT_PUBLIC_MARVEL_ENDPOINT=${NEXT_PUBLIC_MARVEL_ENDPOINT}" >> .env.production.local
          echo "MARVEL_API_KEY=${MARVEL_API_KEY}" >> .env.production.local
          echo "MARVEL_ENDPOINT=${MARVEL_ENDPOINT}" >> .env.production.local

      - name: Create .env.prod in functions
        run: |
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_API_KEY=${NEXT_PUBLIC_FIREBASE_CLIENT_API_KEY}" >> functions/.env.prod
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_CLIENT_AUTH_DOMAIN}" >> functions/.env.prod
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_CLIENT_PROJECT_ID}" >> functions/.env.prod
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_CLIENT_STORAGE_BUCKET}" >> functions/.env.prod
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_CLIENT_MESSAGING_SENDER_ID}" >> functions/.env.prod
          echo "NEXT_PUBLIC_FIREBASE_CLIENT_APP_ID=${NEXT_PUBLIC_FIREBASE_CLIENT_APP_ID}" >> functions/.env.prod
          echo "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}" >> functions/.env.prod
          echo "NEXT_PUBLIC_MARVEL_ENDPOINT=${NEXT_PUBLIC_MARVEL_ENDPOINT}" >> functions/.env.prod
          echo "MARVEL_API_KEY=${MARVEL_API_KEY}" >> functions/.env.prod
          echo "MARVEL_ENDPOINT=${MARVEL_ENDPOINT}" >> functions/.env.prod

      - name: Build and export
        run: |
          npm run build
          npm run export

      - name: Deploy to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.DEV_FIREBASE_TOKEN }}
        run: |
          npx firebase use kai-platform-sandbox --token "$FIREBASE_TOKEN"
          npx firebase deploy --token "$FIREBASE_TOKEN"
